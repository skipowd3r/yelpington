<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.4/dist/leaflet.css" integrity="sha512-puBpdR0798OZvTTbP4A8Ix/l+A4dHDD0DGqYW6RQ+9jxkRFclaxxQb/SJAWZfWAkuyeQUytO7+7N4QKrDh+drA=="
  crossorigin="" />
<script src="https://unpkg.com/leaflet@1.3.4/dist/leaflet.js" integrity="sha512-nMMmRyTVoLYqjP9hrbed9S+FzjZHW5gY1TWCHA5ckwXZBadntCNs8kEqAWdrb9O7rxbCaA4lKTIWjDXZxflOcA=="
  crossorigin=""></script>
  <title>Fetching Data</title>
</head>

<style>
h1 {
  font-size: 24px;
  font-family: Arial, Helvetica, sans-serif;
}
#pagecontainer {
  display: grid;
  grid-template-columns: 300px auto;
  grid-template-areas: 
  "logo title"
  "restaurants restoinfo"
}

#logo {
  grid-area: logo;
  justify-self: start;
}
#title {
  grid-area: title;
  justify-self: center;
}
#restaurants {
  grid-area: restaurants;
}
#restoinfo {
  grid-area: restoinfo;
}
#map {
  height: 500px;
}

</style>

<body>
<header>

</header>
<div id="pagecontainer">
  <div id="logo"><h1>Yelpington</h1></div>
  <div id="title"><h1>Burlington, VT</h1></div>
  <div id="restaurants"><h1>List of Restaurants</h1></div>
  <div id="restoinfo">
    <div id="map"></div>
    <div id="info"> 
    </div>
  </div>
</div>

</body>

<script>
let name = document.location.pathname.slice(1);

if (!name) {
  console.log("no place name specfied");
  populatePage();

} else {
  
  console.log("fetching place named '" + name + "'");
  fetch(name)
    .then(function (response) {
      return response.text();
    })
    .then(function (myText) {
      console.log(myText);
    });
}


function populatePage(){
  makeMap('150 Main St, Burlington VT 05401');

  fetch('all.json')
  .then(response => response.json())
  .then(all => all.forEach(resto => {
    console.log(`${resto}`)
    let filename = `${resto}.json`
    fetch(filename)
    .then(response => {return response.json()})
    .then(restaurant => {
      addMarker({restaurant})
      document.getElementById("restaurants").innerHTML +=  `<div onclick='getInfo("${filename}")'> ${restaurant.name} </div> <br>`;
    })
    }));
}


function getInfo(filename){
  fetch(filename)
  .then(response => response.json())
  .then(json => {
    document.getElementById('info').innerHTML = `<div> <h1>${json.name}</h1> <h2>Address:</h2> ${json.address} <h2>Phone:</h2> ${json.phone} <h2>Website:</h2> ${json.website} <h2>Notes:</h2> ${json.notes.join(" <br> ")} </div>`;
    //makeMap(`${json.address}`);
    //addMarker(`${json.address}`)
  });
}


function makeMap(address){
  console.log({address})
  let encodedAddress = encodeURIComponent(address)
  console.log({encodedAddress})

  fetch(`https://nominatim.openstreetmap.org/search/?q=${encodedAddress}&format=json`)
  .then(response => {return response.json()})
  .then(result => {
      let coords = [result[0].lat, result[0].lon];
      mymap = L.map('map').setView(coords, 15.5);
      L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token={accessToken}', {
        attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, <a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery Â© <a href="https://www.mapbox.com/">Mapbox</a>',
        maxZoom: 20,
        id: 'mapbox.streets',
        accessToken: 'pk.eyJ1Ijoic2tpcG93ZDNyIiwiYSI6ImNqbm5hYnQ3cDAwZ3gzcXRhanllOGJ4MzEifQ.T1lUzD4Hs3pcOdKFlREpAg'
      }).addTo(mymap);
})}

function addMarker({restaurant}){
  if (!checkBTVAddress(restaurant.address)){
    restaurant.address += " 05401";
  }
  console.log(restaurant.address)

  let encodedAddress = encodeURIComponent(restaurant.address)
  console.log({encodedAddress})  

  fetch(`https://nominatim.openstreetmap.org/search/?q=${encodedAddress}&format=json`)
  .then(response => {return response.json()})
  .then(result => {
    let coords = [result[0].lat, result[0].lon];
    restaurant.coords = coords;
    console.log(restaurant.coords)

    let marker = L.marker(coords).addTo(mymap);
    marker.bindPopup(`<b>${restaurant.name}</b> <br> ${restaurant.address} <br> ${restaurant.phone} <br> ${restaurant.website} <br> ${restaurant.notes.join('<br>')}`);

  })
}


function checkBTVAddress(address){
  if(address.includes("05401")){
    return true;
  } else {
      return false;
  }
}

</script>